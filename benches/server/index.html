<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZX Server-Side non-keyed</title>
    <link href="/css/currentStyle.css" rel="stylesheet"/>
</head>
<body>
    <div id="main">
        <div class="container">
            <div class="jumbotron">
                <div class="row">
                    <div class="col-md-6">
                        <h1>ZX Server-Side "non-keyed"</h1>
                    </div>
                    <div class="col-md-6" id="buttons-container" style="display:none">
                        <div class="row">
                            <div class="col-sm-6 smallpad">
                                <button type="button" class="btn btn-primary btn-block" id="run">
                                    Create 1,000 rows
                                </button>
                            </div>
                            <div class="col-sm-6 smallpad">
                                <button type="button" class="btn btn-primary btn-block" id="runlots">
                                    Create 10,000 rows
                                </button>
                            </div>
                            <div class="col-sm-6 smallpad">
                                <button type="button" class="btn btn-primary btn-block" id="add">
                                    Append 1,000 rows
                                </button>
                            </div>
                            <div class="col-sm-6 smallpad">
                                <button type="button" class="btn btn-primary btn-block" id="update">
                                    Update every 10th row
                                </button>
                            </div>
                            <div class="col-sm-6 smallpad">
                                <button type="button" class="btn btn-primary btn-block" id="clear">
                                    Clear
                                </button>
                            </div>
                            <div class="col-sm-6 smallpad">
                                <button type="button" class="btn btn-primary btn-block" id="swaprows">
                                    Swap Rows
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <table class="table table-hover table-striped test-data">
                <tbody id="tbody"></tbody>
            </table>
            <span class="preloadicon glyphicon glyphicon-remove" aria-hidden="true"></span>
        </div>
    </div>
    
    <script>
        // Server-side rendering client - operations handled by ZX server on port 3000
        const SERVER_URL = 'http://localhost:3000';
        let selected = null;
        let startTime = 0;
        
        async function performAction(action) {
            // Benchmark timing: start before fetch
            const clientStart = performance.now();
            console.log(`[PERF] ${action} - starting`);
            
            try {
                // Use api=1 to prevent redirect and get the rendered HTML directly
                const fetchStart = performance.now();
                const response = await fetch(`${SERVER_URL}/?action=${action}&api=1`, { 
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit'
                });
                const fetchEnd = performance.now();
                console.log(`[PERF] ${action} - fetch complete: ${(fetchEnd - fetchStart).toFixed(2)}ms`);
                
                // Get the page HTML without redirect
                const textStart = performance.now();
                const html = await response.text();
                const textEnd = performance.now();
                console.log(`[PERF] ${action} - text parse: ${(textEnd - textStart).toFixed(2)}ms`);
                
                // Extract tbody content from the response
                const domStart = performance.now();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const tbody = doc.querySelector('#tbody');
                const domParseEnd = performance.now();
                console.log(`[PERF] ${action} - DOM parse: ${(domParseEnd - domStart).toFixed(2)}ms`);
                
                if (tbody) {
                    const tbodyElement = document.getElementById('tbody');
                    const updateStart = performance.now();
                    tbodyElement.innerHTML = tbody.innerHTML;
                    const updateEnd = performance.now();
                    console.log(`[PERF] ${action} - DOM update: ${(updateEnd - updateStart).toFixed(2)}ms`);
                    
                    // Force a reflow to ensure DOM is updated
                    void tbodyElement.offsetHeight;
                }
                
                selected = null;
                
                const clientEnd = performance.now();
                const totalDuration = clientEnd - clientStart;
                console.log(`[PERF] ${action} - TOTAL: ${totalDuration.toFixed(2)}ms`);
                
            } catch (error) {
                console.error('Error performing action:', error);
                // Don't show alert during benchmark
                if (!window._benchmark_running) {
                    alert('Error: Make sure ZX server is running on port 3000\nDetails: ' + error.message);
                }
            }
        }
        
        document.getElementById('run').addEventListener('click', () => performAction('run'));
        document.getElementById('runlots').addEventListener('click', () => performAction('runlots'));
        document.getElementById('add').addEventListener('click', () => performAction('add'));
        document.getElementById('update').addEventListener('click', () => performAction('update'));
        document.getElementById('clear').addEventListener('click', () => performAction('clear'));
        document.getElementById('swaprows').addEventListener('click', () => performAction('swaprows'));
        
        document.getElementById('tbody').addEventListener('click', async (e) => {
            const link = e.target.closest('a');
            if (link) {
                e.preventDefault();
                const row = link.closest('tr');
                if (!row) return;
                
                if (link.classList.contains('select-link')) {
                    // Select row
                    if (selected) {
                        selected.classList.remove('danger');
                    }
                    row.classList.add('danger');
                    selected = row;
                } else if (link.classList.contains('remove-link')) {
                    // Remove row
                    const id = row.getAttribute('data-id');
                    try {
                        await fetch(`${SERVER_URL}/?remove=${id}&api=1`, { 
                            method: 'GET',
                            mode: 'cors',
                            credentials: 'omit'
                        });
                        row.remove();
                    } catch (error) {
                        console.error('Error removing row:', error);
                    }
                }
            }
        });
        
        // Load initial data on page load
        window.addEventListener('load', async () => {
            try {
                // Reset server state on load
                await fetch(`${SERVER_URL}/?action=reset&api=1`, { mode: 'cors', credentials: 'omit' });
            } catch (e) {
                console.error('Error resetting server:', e);
            }
            // Show buttons after reset
            document.getElementById('buttons-container').style.display = 'block';
        });
    </script>
</body>
</html>
